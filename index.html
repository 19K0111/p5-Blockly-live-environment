<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P5 Block Live Programming Environment</title>
    <script src="node_modules/blockly/blockly_compressed.js"></script>
    <script src="node_modules/blockly/blocks_compressed.js"></script>
    <script src="node_modules/blockly/msg/ja.js"></script>
    <script src="node_modules/blockly/javascript.js"></script>
    <!-- p5.js -->
    <script src="p5/p5.min.js"></script>
    <!-- Bootstrap -->
    <script src="bootstrap/bootstrap.min.js"></script>

    <!-- Bootstrap core CSS -->
    <link href="bootstrap/bootstrap.min.css" rel="stylesheet">

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        body {
            background-color: #ffffff;
            font-family: sans-serif;
            overflow: hidden;
        }

        table {
            height: 100%;
            width: 100%;
        }

        #blockArea {
            height: 99%;
        }

        #p5Preview {
            width: 50%;
            height: 99%;
            left: 50%;
            position: absolute;
        }
    </style>
</head>

<body>
    <div>
        <ul class="nav nav-tabs">
            <li class="nav-item"><a onclick="showBlock()" class="nav-link active" data-bs-toggle="tab"
                    role="tab">Blockly</a>
            </li>
            <li class="nav-item"><a onclick="showText()" class="nav-link" data-bs-toggle="tab" role="tab">Text
                    Editor</a>
            </li>
        </ul>
        <!-- <div class="tab-content">
            <div id="blockly" class="tab-pane active show" role="tabpanel">
            </div>
            <div id="texteditor" class="tab-pane" role="tabpanel">texteditor</div>
        </div> -->
        <!-- <div id="blocklyArea"></div> -->
        <div id="blocklyDiv" style="width:49%;height:99%; position:  absolute;"></div>
        <div id="textDiv" style="width:49%;height:99%; position: absolute;" hidden>
            <!-- Monaco Editor -->
            <div id="container" style="width: 100%; height: 100vh; border: 1px solid grey; ">
            </div>
            <script src="./node_modules/monaco-editor/min/vs/loader.js"></script>
            <script>
                let editor;
                require.config({
                    paths: {
                        vs: "./node_modules/monaco-editor/min/vs"
                    },
                    "vs/nls": {
                        availableLanguages: { "*": "ja" }
                    },
                });

                require(["vs/editor/editor.main"], function () {
                    editor = monaco.editor.create(
                        document.getElementById("container"),
                        {
                            value: [
                                "function setup() {",
                                "    ",
                                "}\n",
                                "function draw() {",
                                "    ",
                                "}\n",
                            ].join("\n"),
                            language: "javascript",
                            automaticLayout: true,
                            // readOnly: true,
                        }
                    );
                    editor.getModel().onDidChangeContent((event) => {
                        // console.log(editor.getValue());
                        // eval("" + editor.getValue() + "_setup_();_draw_();");
                        // execCode = new Function(getCodeBlock());
                        // execCode();

                        let iframe = document.getElementById("p5frame");
                        let current_dir = location.href.split("/");
                        current_dir.pop();
                        let header_html = `\<html\>\<head\>\<script src=\"${current_dir.join("/")}/p5/p5.min.js\"\>\<\/script\>\</head\>\<body\>\<main\>\</main\>\<script\>`;
                        let footer_html = `\<\/script\>\<\/body\>\<\/html\>`;
                        let blob = new Blob([header_html + getCodeBlock() + footer_html]);
                        iframe.src = URL.createObjectURL(blob);

                    })
                    // editor.updateOptions({
                    //   wordWrap: "on",
                    // });
                    // editor.getValue();
                });

                function getCodeBlock() {
                    var data = editor.getValue().replace(/\s+\n/g, "");
                    data = data.replace(/\s+-+/g, "\n");
                    console.log(data);
                    return data;
                };
            </script>
            <script>
                window.addEventListener("resize", function () {
                    let container = document.getElementById("container");
                    console.log(container);
                    container.style.width = "100%";
                    container.style.height = "100vh";
                });
            </script>
        </div>
        <!-- Toolbox begin -->
        <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
            <category name="Logic" colour="#5b80a5">
                <block type="controls_if"></block>
                <block type="logic_compare">
                    <field name="OP">EQ</field>
                </block>
                <block type="logic_operation">
                    <field name="OP">AND</field>
                </block>
                <block type="logic_negate"></block>
                <block type="logic_boolean">
                    <field name="BOOL">TRUE</field>
                </block>
                <block type="logic_null"></block>
                <block type="logic_ternary"></block>
            </category>
            <category name="Loops" colour="#5ba55b">
                <block type="controls_repeat_ext">
                    <value name="TIMES">
                        <shadow type="math_number">
                            <field name="NUM">10</field>
                        </shadow>
                    </value>
                </block>
                <block type="controls_whileUntil">
                    <field name="MODE">WHILE</field>
                </block>
                <block type="controls_for">
                    <field name="VAR" id="lo$0^Mc-W~#wr)U8`Hu0">i</field>
                    <value name="FROM">
                        <shadow type="math_number">
                            <field name="NUM">1</field>
                        </shadow>
                    </value>
                    <value name="TO">
                        <shadow type="math_number">
                            <field name="NUM">10</field>
                        </shadow>
                    </value>
                    <value name="BY">
                        <shadow type="math_number">
                            <field name="NUM">1</field>
                        </shadow>
                    </value>
                </block>
                <block type="controls_forEach">
                    <field name="VAR" id="e{p5`eE@oRO#}X3cVE7C">j</field>
                </block>
                <block type="controls_flow_statements">
                    <field name="FLOW">BREAK</field>
                </block>
            </category>
            <category name="Math" colour="#5b67a5">
                <block type="math_number">
                    <field name="NUM">0</field>
                </block>
                <!-- Added: expression begin-->
                <block type="expression">
                    <field name="expression">1+2</field>
                </block>
                <!-- expression end -->
                <block type="math_arithmetic">
                    <field name="OP">ADD</field>
                    <value name="A">
                        <shadow type="math_number">
                            <field name="NUM">1</field>
                        </shadow>
                    </value>
                    <value name="B">
                        <shadow type="math_number">
                            <field name="NUM">1</field>
                        </shadow>
                    </value>
                </block>
                <block type="math_single">
                    <field name="OP">ROOT</field>
                    <value name="NUM">
                        <shadow type="math_number">
                            <field name="NUM">9</field>
                        </shadow>
                    </value>
                </block>
                <block type="math_trig">
                    <field name="OP">SIN</field>
                    <value name="NUM">
                        <shadow type="math_number">
                            <field name="NUM">45</field>
                        </shadow>
                    </value>
                </block>
                <block type="math_constant">
                    <field name="CONSTANT">PI</field>
                </block>
                <block type="math_number_property">
                    <mutation divisor_input="false"></mutation>
                    <field name="PROPERTY">EVEN</field>
                    <value name="NUMBER_TO_CHECK">
                        <shadow type="math_number">
                            <field name="NUM">0</field>
                        </shadow>
                    </value>
                </block>
                <block type="math_round">
                    <field name="OP">ROUND</field>
                    <value name="NUM">
                        <shadow type="math_number">
                            <field name="NUM">3.1</field>
                        </shadow>
                    </value>
                </block>
                <block type="math_on_list">
                    <mutation op="SUM"></mutation>
                    <field name="OP">SUM</field>
                </block>
                <block type="math_modulo">
                    <value name="DIVIDEND">
                        <shadow type="math_number">
                            <field name="NUM">64</field>
                        </shadow>
                    </value>
                    <value name="DIVISOR">
                        <shadow type="math_number">
                            <field name="NUM">10</field>
                        </shadow>
                    </value>
                </block>
                <block type="math_constrain">
                    <value name="VALUE">
                        <shadow type="math_number">
                            <field name="NUM">50</field>
                        </shadow>
                    </value>
                    <value name="LOW">
                        <shadow type="math_number">
                            <field name="NUM">1</field>
                        </shadow>
                    </value>
                    <value name="HIGH">
                        <shadow type="math_number">
                            <field name="NUM">100</field>
                        </shadow>
                    </value>
                </block>
                <block type="math_random_int">
                    <value name="FROM">
                        <shadow type="math_number">
                            <field name="NUM">1</field>
                        </shadow>
                    </value>
                    <value name="TO">
                        <shadow type="math_number">
                            <field name="NUM">100</field>
                        </shadow>
                    </value>
                </block>
                <block type="math_random_float"></block>
            </category>
            <category name="Text" colour="#5ba58c">
                <block type="text">
                    <field name="TEXT"></field>
                </block>
                <block type="text_join">
                    <mutation items="2"></mutation>
                </block>
                <block type="text_append">
                    <field name="VAR" id="#!(lOF)W=E=49?.$MR}~">item</field>
                    <value name="TEXT">
                        <shadow type="text">
                            <field name="TEXT"></field>
                        </shadow>
                    </value>
                </block>
                <block type="text_length">
                    <value name="VALUE">
                        <shadow type="text">
                            <field name="TEXT">abc</field>
                        </shadow>
                    </value>
                </block>
                <block type="text_isEmpty">
                    <value name="VALUE">
                        <shadow type="text">
                            <field name="TEXT"></field>
                        </shadow>
                    </value>
                </block>
                <block type="text_indexOf">
                    <field name="END">FIRST</field>
                    <value name="VALUE">
                        <block type="variables_get">
                            <field name="VAR" id="O%gT8f4h*!^.iaWvd/nB">text</field>
                        </block>
                    </value>
                    <value name="FIND">
                        <shadow type="text">
                            <field name="TEXT">abc</field>
                        </shadow>
                    </value>
                </block>
                <block type="text_charAt">
                    <mutation at="true"></mutation>
                    <field name="WHERE">FROM_START</field>
                    <value name="VALUE">
                        <block type="variables_get">
                            <field name="VAR" id="O%gT8f4h*!^.iaWvd/nB">text</field>
                        </block>
                    </value>
                </block>
                <block type="text_getSubstring">
                    <mutation at1="true" at2="true"></mutation>
                    <field name="WHERE1">FROM_START</field>
                    <field name="WHERE2">FROM_START</field>
                    <value name="STRING">
                        <block type="variables_get">
                            <field name="VAR" id="O%gT8f4h*!^.iaWvd/nB">text</field>
                        </block>
                    </value>
                </block>
                <block type="text_changeCase">
                    <field name="CASE">UPPERCASE</field>
                    <value name="TEXT">
                        <shadow type="text">
                            <field name="TEXT">abc</field>
                        </shadow>
                    </value>
                </block>
                <block type="text_trim">
                    <field name="MODE">BOTH</field>
                    <value name="TEXT">
                        <shadow type="text">
                            <field name="TEXT">abc</field>
                        </shadow>
                    </value>
                </block>
                <block type="text_print">
                    <value name="TEXT">
                        <shadow type="text">
                            <field name="TEXT">abc</field>
                        </shadow>
                    </value>
                </block>
                <block type="text_prompt_ext">
                    <mutation type="TEXT"></mutation>
                    <field name="TYPE">TEXT</field>
                    <value name="TEXT">
                        <shadow type="text">
                            <field name="TEXT">abc</field>
                        </shadow>
                    </value>
                </block>
            </category>
            <category name="Lists" colour="#745ba5">
                <block type="lists_create_with">
                    <mutation items="0"></mutation>
                </block>
                <block type="lists_create_with">
                    <mutation items="3"></mutation>
                </block>
                <block type="lists_repeat">
                    <value name="NUM">
                        <shadow type="math_number">
                            <field name="NUM">5</field>
                        </shadow>
                    </value>
                </block>
                <block type="lists_length"></block>
                <block type="lists_isEmpty"></block>
                <block type="lists_indexOf">
                    <field name="END">FIRST</field>
                    <value name="VALUE">
                        <block type="variables_get">
                            <field name="VAR" id="hB$Xj{VoHXX)R=OPUf$b">list</field>
                        </block>
                    </value>
                </block>
                <block type="lists_getIndex">
                    <mutation statement="false" at="true"></mutation>
                    <field name="MODE">GET</field>
                    <field name="WHERE">FROM_START</field>
                    <value name="VALUE">
                        <block type="variables_get">
                            <field name="VAR" id="hB$Xj{VoHXX)R=OPUf$b">list</field>
                        </block>
                    </value>
                </block>
                <block type="lists_setIndex">
                    <mutation at="true"></mutation>
                    <field name="MODE">SET</field>
                    <field name="WHERE">FROM_START</field>
                    <value name="LIST">
                        <block type="variables_get">
                            <field name="VAR" id="hB$Xj{VoHXX)R=OPUf$b">list</field>
                        </block>
                    </value>
                </block>
                <block type="lists_getSublist">
                    <mutation at1="true" at2="true"></mutation>
                    <field name="WHERE1">FROM_START</field>
                    <field name="WHERE2">FROM_START</field>
                    <value name="LIST">
                        <block type="variables_get">
                            <field name="VAR" id="hB$Xj{VoHXX)R=OPUf$b">list</field>
                        </block>
                    </value>
                </block>
                <block type="lists_split">
                    <mutation mode="SPLIT"></mutation>
                    <field name="MODE">SPLIT</field>
                    <value name="DELIM">
                        <shadow type="text">
                            <field name="TEXT">,</field>
                        </shadow>
                    </value>
                </block>
                <block type="lists_sort">
                    <field name="TYPE">NUMERIC</field>
                    <field name="DIRECTION">1</field>
                </block>
            </category>
            <category name="Color" colour="#a5745b">
                <block type="colour_picker">
                    <field name="COLOUR">#ff0000</field>
                </block>
                <block type="colour_random"></block>
                <block type="colour_rgb">
                    <value name="RED">
                        <shadow type="math_number">
                            <field name="NUM">100</field>
                        </shadow>
                    </value>
                    <value name="GREEN">
                        <shadow type="math_number">
                            <field name="NUM">50</field>
                        </shadow>
                    </value>
                    <value name="BLUE">
                        <shadow type="math_number">
                            <field name="NUM">0</field>
                        </shadow>
                    </value>
                </block>
                <block type="colour_blend">
                    <value name="COLOUR1">
                        <shadow type="colour_picker">
                            <field name="COLOUR">#ff0000</field>
                        </shadow>
                    </value>
                    <value name="COLOUR2">
                        <shadow type="colour_picker">
                            <field name="COLOUR">#3333ff</field>
                        </shadow>
                    </value>
                    <value name="RATIO">
                        <shadow type="math_number">
                            <field name="NUM">0.5</field>
                        </shadow>
                    </value>
                </block>
            </category>
            <sep></sep>
            <category name="Variables" colour="#a55b80" custom="VARIABLE"></category>
            <category name="Functions" colour="#995ba5" custom="PROCEDURE"></category>
        </xml>
        <!-- Toolbox end -->
        <div id="p5Preview">
            <span>p5.js preview</span>
            <iframe id="p5frame" frameborder="0" style="width: 100%;height: 94%;"></iframe>
            <!-- <main></main>
            <script>
                let canvas = null;
                let x = 0;
                function setup() {
                    // createCanvas(400, 500);
                    // frameRate(5);
                }

                function draw() {
                    // fill(x);
                    // rect(100, 200, 300, 300);
                    // x += 5;
                    userCode();
                }

                function userCode() {

                }

            </script> -->
        </div>
    </div>
    <script>
        // type expression: 
        Blockly.Blocks['expression'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField(new Blockly.FieldTextInput("1+2"), "expression");
                this.setOutput(true, "Number");
                this.setColour(230);
                this.setTooltip("四則演算を含む式。");
                this.setHelpUrl("");
            }
        };

        /* TODO: Change toolbox XML ID if necessary. Can export toolbox XML from Workspace Factory. */
        var toolbox = document.getElementById("toolbox");

        var options = {
            toolbox: toolbox,
            collapse: true,
            comments: true,
            disable: true,
            maxBlocks: Infinity,
            trashcan: true,
            horizontalLayout: false,
            toolboxPosition: 'start',
            css: true,
            media: 'https://blockly-demo.appspot.com/static/media/',
            rtl: false,
            scrollbars: true,
            sounds: true,
            oneBasedIndex: true,
            grid: {
                spacing: 20,
                length: 2,
                colour: '#888',
                snap: false
            },
            zoom: {
                controls: true,
                wheel: true,
                startScale: 1,
                maxScale: 3,
                minScale: 0.3,
                scaleSpeed: 1.2
            }
        };

        /* Inject your workspace */
        var workspace = Blockly.inject("blocklyDiv", options);

        /* Load Workspace Blocks from XML to workspace. Remove all code below if no blocks to load */

        /* TODO: Change workspace blocks XML ID if necessary. Can export workspace blocks XML from Workspace Factory. */
        var workspaceBlocks = document.getElementById("workspaceBlocks");

        /* Load blocks to workspace. */
        Blockly.Xml.domToWorkspace(workspaceBlocks, workspace);

        function showBlock() {
            let blocklyContent = document.getElementById("blocklyDiv");
            let textContent = document.getElementById("textDiv");
            blocklyContent.hidden = false;
            textContent.hidden = true;
        }

        function showText() {
            let blocklyContent = document.getElementById("blocklyDiv");
            let textContent = document.getElementById("textDiv");
            blocklyContent.hidden = true;
            textContent.hidden = false;
        }
    </script>

</body>

</html>