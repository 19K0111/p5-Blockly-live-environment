<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>p5.js Block Live Programming Environment</title>
    <script src="node_modules/blockly/blockly_compressed.js"></script>
    <script src="node_modules/blockly/blocks_compressed.js"></script>
    <script src="node_modules/blockly/msg/ja.js"></script>
    <script src="node_modules/blockly/javascript.js"></script>
    <script src="node_modules/blockly/javascript_compressed.js"></script>

    <!-- p5.js -->
    <script src="p5/p5.min.js"></script>
    <script src="p5/addons/p5.sound.min.js"></script>
    <!-- Bootstrap -->
    <!-- <script src="bootstrap/bootstrap.min.js"></script> -->
    <script src="bootstrap-5.3.0-dist/js/bootstrap.min.js"></script>
    <script src="bootstrap-5.3.0-dist/js/bootstrap.bundle.min.js"></script>

    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"
        integrity="sha384-Gr6Lu2Ajx28mzwyVR8CFkULdCU7kMlZ9UthllibdOSo6qAiN+yXNHqtgdTvFXMT4"
        crossorigin="anonymous"></script>

    <!-- ローカル等でサーバを構築する必要があるモジュール -->
    <script src="main.js"></script>

    <!-- Bootstrap core CSS -->
    <!-- <link href="bootstrap/bootstrap.min.css" rel="stylesheet"> -->
    <link href="bootstrap-5.3.0-dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        body {
            background-color: #ffffff;
            font-family: sans-serif;
            overflow: hidden;
        }

        table {
            height: 100%;
            width: 100%;
        }

        #blockArea {
            height: 99%;
        }

        #p5Preview {
            width: 50%;
            height: 99%;
            left: 50%;
            position: absolute;
        }
    </style>
</head>

<body>
    <div>
        <!-- <ul class="nav nav-tabs">
            <li class="nav-item"><a onclick="showBlock()" class="nav-link active" data-bs-toggle="tab"
                    role="tab">Blockly</a>
            </li>
            <li class="nav-item"><a onclick="showText()" class="nav-link" data-bs-toggle="tab" role="tab">Text
                    Editor</a>
            </li>
            <li class="nav-item">
                <a class="nav-link disabled" data-bs-toggle="tab" role="tab"></a>
            </li>
            <li class="nav-item">
                <a onclick="" class="nav-link" data-bs-toggle="tab" role="tab">Load</a>
            </li>
            <li class="nav-item">
                <a onclick="" class="nav-link" data-bs-toggle="tab" role="tab">Save</a>
            </li>
        </ul> -->
        <ul class="nav nav-pills" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pills-blockly-tab" data-bs-toggle="pill"
                    data-bs-target="#blocklyDiv" type="button" role="tab" aria-controls="blocklyDiv"
                    aria-selected="true">Blockly</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pills-text-tab" data-bs-toggle="pill" data-bs-target="#textDiv"
                    type="button" role="tab" aria-controls="textDiv" aria-selected="false">Text Editor</button>
            </li>
            <li class="nav-item">
                <a class="nav-link disabled" data-bs-toggle="tab" role="tab"></a>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button"
                    aria-expanded="false">ファイル</a>
                <ul class="dropdown-menu"
                    style="font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;">
                    <li><a class="dropdown-item" onclick="blocklyNewFile()" id="f_new">新規</a></li>
                    <li><a class="dropdown-item" onclick="blocklyOpenFile()" id="f_open">開く</a></li>
                    <li><a class="dropdown-item" onclick="blocklySaveFile(true)" id="f_save">上書き保存</a></li>
                    <li><a class="dropdown-item" onclick="blocklySaveFile(false)" id="f_saveas">名前をつけて保存</a></li>
                    <!-- <li><a class="dropdown-item" href="#">Something else here</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="#">Separated link</a></li> -->
                </ul>
            </li>
            <li class="nav-item" role="presentation">
                <span class="nav-link disabled" id="fileName">無題</span>
            </li>
        </ul>
        <!-- <div class="tab-content">
            <div id="blockly" class="tab-pane active show" role="tabpanel">
            </div>
            <div id="texteditor" class="tab-pane" role="tabpanel">texteditor</div>
        </div> -->
        <!-- <div id="blocklyArea"></div> -->
        <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane show active" id="blocklyDiv" style="width:49%;height:99%; position: absolute;"
                role="tabpanel" aria-labelledby="pills-blockly-tab" tabindex="0"></div>
            <div class="tab-pane" id="textDiv" style="width:49%;height:99%; position: absolute;" role="tabpanel"
                aria-labelledby="pills-text-tab" tabindex="0">
                <!-- Monaco Editor -->
                <div id="container" style="width: 100%; height: 100vh; border: 1px solid grey; ">
                </div>
                <script src="./node_modules/monaco-editor/min/vs/loader.js"></script>
                <script>
                    let editor;
                    require.config({
                        paths: {
                            vs: "./node_modules/monaco-editor/min/vs"
                        },
                        "vs/nls": {
                            availableLanguages: { "*": "ja" }
                        },
                    });

                    require(["vs/editor/editor.main"], function () {
                        editor = monaco.editor.create(
                            document.getElementById("container"),
                            {
                                value: [
                                    "function setup() {",
                                    "    ",
                                    "}\n",
                                    "function draw() {",
                                    "    ",
                                    "}\n",
                                ].join("\n"),
                                language: "javascript",
                                automaticLayout: true,
                                // readOnly: true,
                            }
                        );
                        editor.getModel().onDidChangeContent((event) => {
                            // console.log(editor.getValue());
                            // eval("" + editor.getValue() + "_setup_();_draw_();");
                            // execCode = new Function(getCodeBlock());
                            // execCode();

                            let iframe = document.getElementById("p5frame");
                            let current_dir = location.href.split("/");
                            current_dir.pop();
                            // let header_html = `\<html\>\<head\>\<script src=\"${current_dir.join("/")}/p5/p5.min.js\"\>\<\/script\>\</head\>\<body\>\<main\>\</main\>\<script\>`;
                            let header_html = `\<html\>\<head\>\<script src=\"https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"\>\<\/script\>\<script src=\"https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.sound.min.js"\>\<\/script\>\<script src=\"https://cdn.socket.io/4.7.4/socket.io.min.js\" integrity=\"sha384-Gr6Lu2Ajx28mzwyVR8CFkULdCU7kMlZ9UthllibdOSo6qAiN+yXNHqtgdTvFXMT4\" crossorigin=\"anonymous\"\>\</script\>\</head\>\<body\>\<main\>\</main\>\<script\>`;
                            let socket_script = `var socket = io('http://localhost:3000');/*socket.on('greeting-from-server', function (message) {document.body.appendChild(document.createTextNode(message.greeting));socket.emit('greeting-from-client', {greeting: 'Hello Server'});});*/window.addEventListener('beforeunload',(event)=\>{socket.disconnect();console.log("disconnected: ", socket.id);});`;
                            let footer_html = `\<\/script\>\<\/body\>\<\/html\>`;
                            let blob = new Blob([header_html + socket_script + getCodeBlock() + footer_html], { type: "text/html" });
                            iframe.src = URL.createObjectURL(blob);

                        })
                        // editor.updateOptions({
                        //   wordWrap: "on",
                        // });
                        // editor.getValue();
                    });

                                function getCodeBlock() {
                                    var data = editor.getValue();
                                    // var data = editor.getValue().replace(/\s+\n/g, "");
                                    // data = data.replace(/\s+-+/g, "\n");
                                    console.log(data);
                                    return data;
                                };
                            </script>
            </div>
        </div>

        <!-- <div id="blocklyDiv" style="width:49%;height:99%; position:  absolute;"></div>
        <div id="textDiv" style="width:49%;height:99%; position: absolute;" hidden> -->
    </div>
    <!-- Toolbox begin -->
    <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
        <category name="Logic" colour="#5b80a5">
            <block type="controls_if"></block>
            <block type="logic_compare">
                <field name="OP">EQ</field>
            </block>
            <block type="logic_operation">
                <field name="OP">AND</field>
            </block>
            <block type="logic_negate"></block>
            <block type="logic_boolean">
                <field name="BOOL">TRUE</field>
            </block>
            <block type="logic_null"></block>
            <block type="logic_ternary"></block>
        </category>
        <category name="Loops" colour="#5ba55b">
            <block type="controls_repeat_ext">
                <value name="TIMES">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
            <block type="controls_whileUntil">
                <field name="MODE">WHILE</field>
            </block>
            <block type="controls_for">
                <field name="VAR" id="lo$0^Mc-W~#wr)U8`Hu0">i</field>
                <value name="FROM">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
                <value name="TO">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
                <value name="BY">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
            </block>
            <block type="controls_forEach">
                <field name="VAR" id="e{p5`eE@oRO#}X3cVE7C">j</field>
            </block>
            <block type="controls_flow_statements">
                <field name="FLOW">BREAK</field>
            </block>
        </category>
        <category name="Math" colour="#5b67a5">
            <block type="math_number">
                <field name="NUM">0</field>
            </block>
            <!-- Added: math_expression begin-->
            <block type="math_expression">
                <field name="EXPR">1+2</field>
            </block>
            <!-- math_expression end -->
            <block type="math_arithmetic">
                <field name="OP">ADD</field>
                <value name="A">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
                <value name="B">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
            </block>
            <block type="math_single">
                <field name="OP">ROOT</field>
                <value name="NUM">
                    <shadow type="math_number">
                        <field name="NUM">9</field>
                    </shadow>
                </value>
            </block>
            <block type="math_trig">
                <field name="OP">SIN</field>
                <value name="NUM">
                    <shadow type="math_number">
                        <field name="NUM">45</field>
                    </shadow>
                </value>
            </block>
            <block type="math_constant">
                <field name="CONSTANT">PI</field>
            </block>
            <block type="math_number_property">
                <mutation divisor_input="false"></mutation>
                <field name="PROPERTY">EVEN</field>
                <value name="NUMBER_TO_CHECK">
                    <shadow type="math_number">
                        <field name="NUM">0</field>
                    </shadow>
                </value>
            </block>
            <block type="math_round">
                <field name="OP">ROUND</field>
                <value name="NUM">
                    <shadow type="math_number">
                        <field name="NUM">3.1</field>
                    </shadow>
                </value>
            </block>
            <block type="math_on_list">
                <mutation op="SUM"></mutation>
                <field name="OP">SUM</field>
            </block>
            <block type="math_modulo">
                <value name="DIVIDEND">
                    <shadow type="math_number">
                        <field name="NUM">64</field>
                    </shadow>
                </value>
                <value name="DIVISOR">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
            <block type="math_constrain">
                <value name="VALUE">
                    <shadow type="math_number">
                        <field name="NUM">50</field>
                    </shadow>
                </value>
                <value name="LOW">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
                <value name="HIGH">
                    <shadow type="math_number">
                        <field name="NUM">100</field>
                    </shadow>
                </value>
            </block>
            <block type="math_random_int">
                <value name="FROM">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
                <value name="TO">
                    <shadow type="math_number">
                        <field name="NUM">100</field>
                    </shadow>
                </value>
            </block>
            <block type="math_random_float"></block>
        </category>
        <category name="Text" colour="#5ba58c">
            <block type="text">
                <field name="TEXT"></field>
            </block>
            <block type="text_join">
                <mutation items="2"></mutation>
            </block>
            <block type="text_append">
                <field name="VAR" id="#!(lOF)W=E=49?.$MR}~">item</field>
                <value name="TEXT">
                    <shadow type="text">
                        <field name="TEXT"></field>
                    </shadow>
                </value>
            </block>
            <block type="text_length">
                <value name="VALUE">
                    <shadow type="text">
                        <field name="TEXT">abc</field>
                    </shadow>
                </value>
            </block>
            <block type="text_isEmpty">
                <value name="VALUE">
                    <shadow type="text">
                        <field name="TEXT"></field>
                    </shadow>
                </value>
            </block>
            <block type="text_indexOf">
                <field name="END">FIRST</field>
                <value name="VALUE">
                    <block type="variables_get">
                        <field name="VAR" id="O%gT8f4h*!^.iaWvd/nB">text</field>
                    </block>
                </value>
                <value name="FIND">
                    <shadow type="text">
                        <field name="TEXT">abc</field>
                    </shadow>
                </value>
            </block>
            <block type="text_charAt">
                <mutation at="true"></mutation>
                <field name="WHERE">FROM_START</field>
                <value name="VALUE">
                    <block type="variables_get">
                        <field name="VAR" id="O%gT8f4h*!^.iaWvd/nB">text</field>
                    </block>
                </value>
            </block>
            <block type="text_getSubstring">
                <mutation at1="true" at2="true"></mutation>
                <field name="WHERE1">FROM_START</field>
                <field name="WHERE2">FROM_START</field>
                <value name="STRING">
                    <block type="variables_get">
                        <field name="VAR" id="O%gT8f4h*!^.iaWvd/nB">text</field>
                    </block>
                </value>
            </block>
            <block type="text_changeCase">
                <field name="CASE">UPPERCASE</field>
                <value name="TEXT">
                    <shadow type="text">
                        <field name="TEXT">abc</field>
                    </shadow>
                </value>
            </block>
            <block type="text_trim">
                <field name="MODE">BOTH</field>
                <value name="TEXT">
                    <shadow type="text">
                        <field name="TEXT">abc</field>
                    </shadow>
                </value>
            </block>
            <block type="text_print">
                <value name="TEXT">
                    <shadow type="text">
                        <field name="TEXT">abc</field>
                    </shadow>
                </value>
            </block>
            <block type="text_prompt_ext">
                <mutation type="TEXT"></mutation>
                <field name="TYPE">TEXT</field>
                <value name="TEXT">
                    <shadow type="text">
                        <field name="TEXT">abc</field>
                    </shadow>
                </value>
            </block>
        </category>
        <category name="Lists" colour="#745ba5">
            <block type="lists_create_with">
                <mutation items="0"></mutation>
            </block>
            <block type="lists_create_with">
                <mutation items="3"></mutation>
            </block>
            <block type="lists_repeat">
                <value name="NUM">
                    <shadow type="math_number">
                        <field name="NUM">5</field>
                    </shadow>
                </value>
            </block>
            <block type="lists_length"></block>
            <block type="lists_isEmpty"></block>
            <block type="lists_indexOf">
                <field name="END">FIRST</field>
                <value name="VALUE">
                    <block type="variables_get">
                        <field name="VAR" id="hB$Xj{VoHXX)R=OPUf$b">list</field>
                    </block>
                </value>
            </block>
            <block type="lists_getIndex">
                <mutation statement="false" at="true"></mutation>
                <field name="MODE">GET</field>
                <field name="WHERE">FROM_START</field>
                <value name="VALUE">
                    <block type="variables_get">
                        <field name="VAR" id="hB$Xj{VoHXX)R=OPUf$b">list</field>
                    </block>
                </value>
            </block>
            <block type="lists_setIndex">
                <mutation at="true"></mutation>
                <field name="MODE">SET</field>
                <field name="WHERE">FROM_START</field>
                <value name="LIST">
                    <block type="variables_get">
                        <field name="VAR" id="hB$Xj{VoHXX)R=OPUf$b">list</field>
                    </block>
                </value>
            </block>
            <block type="lists_getSublist">
                <mutation at1="true" at2="true"></mutation>
                <field name="WHERE1">FROM_START</field>
                <field name="WHERE2">FROM_START</field>
                <value name="LIST">
                    <block type="variables_get">
                        <field name="VAR" id="hB$Xj{VoHXX)R=OPUf$b">list</field>
                    </block>
                </value>
            </block>
            <block type="lists_split">
                <mutation mode="SPLIT"></mutation>
                <field name="MODE">SPLIT</field>
                <value name="DELIM">
                    <shadow type="text">
                        <field name="TEXT">,</field>
                    </shadow>
                </value>
            </block>
            <block type="lists_sort">
                <field name="TYPE">NUMERIC</field>
                <field name="DIRECTION">1</field>
            </block>
        </category>
        <category name="Color" colour="#a5745b">
            <block type="colour_picker">
                <field name="COLOUR">#ff0000</field>
            </block>
            <block type="colour_random"></block>
            <block type="colour_rgb">
                <value name="RED">
                    <shadow type="math_number">
                        <field name="NUM">100</field>
                    </shadow>
                </value>
                <value name="GREEN">
                    <shadow type="math_number">
                        <field name="NUM">50</field>
                    </shadow>
                </value>
                <value name="BLUE">
                    <shadow type="math_number">
                        <field name="NUM">0</field>
                    </shadow>
                </value>
            </block>
            <block type="colour_blend">
                <value name="COLOUR1">
                    <shadow type="colour_picker">
                        <field name="COLOUR">#ff0000</field>
                    </shadow>
                </value>
                <value name="COLOUR2">
                    <shadow type="colour_picker">
                        <field name="COLOUR">#3333ff</field>
                    </shadow>
                </value>
                <value name="RATIO">
                    <shadow type="math_number">
                        <field name="NUM">0.5</field>
                    </shadow>
                </value>
            </block>
        </category>
        <sep></sep>
        <category name="Variables" colour="#a55b80" custom="VARIABLE"></category>
        <category name="Functions" colour="#995ba5" custom="PROCEDURE" id="function_category"></category>
        <sep></sep>
        <category name="p5.js" colour="#ed225e" id="p5_category">
            <category name="General" colour="#ed225e" id="p5_general"></category>
        </category>
        <sep></sep>
        <sep></sep>
        <sep></sep>
        <sep></sep>
        <sep></sep>
    </xml>
    <xml id="startBlocks" style="display: none;">
        <!-- ページを開いたときに配置させるブロック -->
        <!-- <block type="math_expression" x="0" y="0">
                <field name="EXPR">1+2</field>
            </block> -->
        <block type="p5_setup" x="20" y="20"></block>
        <block type="p5_draw" x="20" y="120"></block>
    </xml>
    <!-- Toolbox end -->
    <div id="p5Preview">
        <span>p5.js preview</span>
        <iframe id="p5frame" frameborder="0" style="width: 100%;height: 94%;"></iframe>
        <!-- <main></main>
            <script>
                let canvas = null;
                let x = 0;
                function setup() {
                    // createCanvas(400, 500);
                    // frameRate(5);
                }

                function draw() {
                    // fill(x);
                    // rect(100, 200, 300, 300);
                    // x += 5;
                    userCode();
                }

                function userCode() {

                }

            </script> -->
    </div>

    <!-- Modal -->
    <div class="modal fade" id="saveRemindModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="staticBackdropLabel">p5.js Live Environment</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    保存していない内容は失われますがよろしいですか？
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-primary"
                        onclick='document.getElementById("fileName").innerText=title;blocklyNewFile();'
                        data-bs-dismiss="modal">はい</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        const untitled = "無題";
        const supportedEvents = new Set([
            Blockly.Events.BLOCK_CHANGE,
            Blockly.Events.BLOCK_CREATE,
            Blockly.Events.BLOCK_DELETE,
            Blockly.Events.BLOCK_MOVE,
        ]);
        let loadedXml;
        let title;
        let globalHandle;

        // type math_expression: 
        Blockly.Blocks['math_expression'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField(new Blockly.FieldTextInput("1+2"), "EXPR");
                this.setOutput(true, "Number");
                this.setColour(230);
                this.setTooltip("四則演算を含む式。");
                this.setHelpUrl("");
            }
        };
        javascript.javascriptGenerator.forBlock["math_expression"] = function (block, generator) {
            var value_name = generator.valueToCode(block, "EXPR", javascript.Order.ATOMIC);
            // console.log(block.getFieldValue("EXPR"));
            var code = block.getFieldValue("EXPR"); // ex. 2*3+4
            return [code, javascript.Order.NONE];
        };

        // カテゴリのDOMを取得
        let p5_category = document.getElementById("p5_category");
        let function_category = document.getElementById("function_category");

        let p5_general = document.getElementById("p5_general");

        for (const f of ["preload", "setup", "draw"]) {
            // p5 preload, setup, draw ブロックの定義
            Blockly.Blocks[`p5_${f}`] = {
                init: function () {
                    this.appendStatementInput("STATEMENTS")
                        .setCheck(null)
                        .appendField(`${f}`);
                    this.setColour(290);
                    this.setTooltip("");
                    this.setHelpUrl(`https://p5js.org/reference/#/p5/${f}`);
                }
            };

            // p5 preload, setup, draw コード生成の定義
            javascript.javascriptGenerator.forBlock[`p5_${f}`] = function (block, generator) {
                var statements_statements = generator.statementToCode(block, 'STATEMENTS');
                // TODO: Assemble javascript into code variable.
                var code = `function ${f}(){\n${generator.statementToCode(block, 'STATEMENTS')}}`;
                return code;
            };

            // preload, setup, drawをp5カテゴリに追加
            let new_block = document.createElement("block");
            new_block.setAttribute("type", `p5_${f}`);
            p5_general.appendChild(new_block);
        }


        // // p5 setup() ブロックの定義
        // Blockly.Blocks['p5_setup'] = {
        //     init: function () {
        //         this.appendStatementInput("STATEMENTS")
        //             .setCheck(null)
        //             .appendField("setup");
        //         this.setColour(290);
        //         this.setTooltip("");
        //         this.setHelpUrl("https://p5js.org/reference/#/p5/setup");
        //     }
        // };

        // // p5 setup() コード生成の定義
        // javascript.javascriptGenerator.forBlock['p5_setup'] = function (block, generator) {
        //     var statements_statements = generator.statementToCode(block, 'STATEMENTS');
        //     // TODO: Assemble javascript into code variable.
        //     var code = `function setup(){\n${generator.statementToCode(block, 'STATEMENTS')}}`;
        //     return code;
        // };

        // // p5 draw() ブロックの定義
        // Blockly.Blocks['p5_draw'] = {
        //     init: function () {
        //         this.appendStatementInput("STATEMENTS")
        //             .setCheck(null)
        //             .appendField("draw");
        //         this.setColour(290);
        //         this.setTooltip("");
        //         this.setHelpUrl("https://p5js.org/reference/#/p5/draw");
        //     }
        // };

        // // p5 draw() コード生成の定義
        // javascript.javascriptGenerator.forBlock['p5_draw'] = function (block, generator) {
        //     var statements_statements = generator.statementToCode(block, 'STATEMENTS');
        //     // TODO: Assemble javascript into code variable.
        //     var code = `function draw(){\n${generator.statementToCode(block, 'STATEMENTS')}}`;
        //     return code;
        // };

        // // setup, drawをp5カテゴリに追加
        // for (const f of ["setup", "draw"]) {
        //     let new_block = document.createElement("block");
        //     new_block.setAttribute("type", `p5_${f}`);
        //     p5_general.appendChild(new_block);
        // }

        // Function argument blocks
        const ARG_MAX = 4; // 最大の引数の個数
        for (let i = 2; i <= ARG_MAX; i++) {
            // Block定義
            Blockly.Blocks[`function_${i}args`] = {
                init: function () {
                    this.appendValueInput("ARG1")
                        .setCheck(null);
                    for (let j = 2; j <= i; j++) {
                        this.appendValueInput(`ARG${j}`)
                            .setCheck(null)
                            .appendField(",");
                    }
                    this.appendEndRowInput();
                    this.setOutput(true, null);
                    this.setColour(230);
                    this.setTooltip("");
                    this.setHelpUrl("");
                }
            };

            // コード生成の定義
            javascript.javascriptGenerator.forBlock[`function_${i}args`] = function (block, generator) {
                // TODO: Assemble javascript into code variable.
                var code = `${generator.valueToCode(block, 'ARG1', javascript.Order.NONE)}`; // 1個目の引数を入れる部分
                for (let j = 2; j <= i; j++) {
                    code = `${code}, ${generator.valueToCode(block, `ARG${j}`, javascript.Order.NONE)}`; // j(<=i)個目の引数を入れる部分
                }
                // TODO: Change ORDER_NONE to the correct strength.
                return [code, javascript.Order.NONE];
            };

            // ブロック一覧に配置
            let new_block = document.createElement("block");
            new_block.setAttribute("type", `function_${i}args`);
            let block_value = document.createElement("value");
            block_value.setAttribute("name", "ARG1");
            let block_value_shadow = document.createElement("shadow");
            block_value_shadow.setAttribute("type", "math_expression");
            let block_value_shadow_field = document.createElement("field");
            block_value_shadow_field.setAttribute("name", "EXPR");
            block_value_shadow_field.textContent = "0";
            block_value_shadow.appendChild(block_value_shadow_field);
            block_value.appendChild(block_value_shadow);
            new_block.appendChild(block_value);
            for (let j = 2; j <= i; j++) {
                let block_value = document.createElement("value");
                block_value.setAttribute("name", `ARG${j}`);
                let block_value_shadow = document.createElement("shadow");
                block_value_shadow.setAttribute("type", "math_expression");
                let block_value_shadow_field = document.createElement("field");
                block_value_shadow_field.setAttribute("name", "EXPR");
                block_value_shadow_field.textContent = "0";
                block_value_shadow.appendChild(block_value_shadow_field);
                block_value.appendChild(block_value_shadow);
                new_block.appendChild(block_value);
            }
            p5_general.appendChild(new_block);
        }

        // 式を文にするブロック
        {
            Blockly.Blocks['instance_statement'] = {
                init: function () {
                    this.appendValueInput("EXPR")
                        .setCheck(null);
                    this.setInputsInline(true);
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(290);
                    this.setTooltip("");
                    this.setHelpUrl("");
                }
            };

            // コード生成の定義
            javascript.javascriptGenerator.forBlock['instance_statement'] = function (block, generator) {
                var value_expr = generator.valueToCode(block, 'EXPR', javascript.Order.NONE);
                // TODO: Assemble javascript into code variable.
                var code = `${value_expr};\n`;
                return code;
            };

            // ブロック一覧に配置
            let new_block = document.createElement("block");
            new_block.setAttribute("type", "instance_statement");
            let block_value = document.createElement("value");
            block_value.setAttribute("name", "EXPR");
            let block_value_shadow = document.createElement("shadow");
            block_value_shadow.setAttribute("type", "math_expression");
            let block_value_shadow_field = document.createElement("field");
            block_value_shadow_field.setAttribute("name", "EXPR");
            block_value_shadow_field.textContent = "instance";
            block_value_shadow.appendChild(block_value_shadow_field);
            block_value.appendChild(block_value_shadow);
            new_block.appendChild(block_value);
            p5_general.appendChild(new_block);

        }


        // インスタンス式ブロック1
        {
            Blockly.Blocks['instance_expression_1'] = {
                init: function () {
                    this.appendValueInput("INSTANCE")
                        .setCheck(null);
                    this.appendDummyInput()
                        .appendField(".");
                    this.appendValueInput("IDENT")
                        .setCheck(null);
                    this.setOutput(true, null);
                    this.setColour(230);
                    this.setTooltip("");
                    this.setHelpUrl("");
                }
            };

            // コード生成の定義
            javascript.javascriptGenerator.forBlock['instance_expression_1'] = function (block, generator) {
                var value_instance = generator.valueToCode(block, 'INSTANCE', javascript.Order.NONE);
                var value_ident = generator.valueToCode(block, 'IDENT', javascript.Order.NONE);
                // TODO: Assemble javascript into code variable.
                var code = `${value_instance}.${value_ident}`;
                return [code, javascript.Order.NONE];
            };

            // ブロック一覧に配置
            let i_statement = document.createElement("block");
            i_statement.setAttribute("type", "instance_statement");
            let i_statement_value = document.createElement("value");
            i_statement_value.setAttribute("name", "EXPR");

            let new_block = document.createElement("block");
            new_block.setAttribute("type", "instance_expression_1")

            let block_value = document.createElement("value");
            block_value.setAttribute("name", "INSTANCE");
            let block_value_shadow = document.createElement("shadow");
            block_value_shadow.setAttribute("type", "math_expression");
            let block_value_shadow_field = document.createElement("field");
            block_value_shadow_field.setAttribute("name", "EXPR");
            block_value_shadow_field.textContent = "instance";

            let block_value2 = document.createElement("value");
            block_value2.setAttribute("name", "IDENT");
            let block_value_shadow2 = document.createElement("shadow");
            block_value_shadow2.setAttribute("type", "math_expression");
            let block_value_shadow_field2 = document.createElement("field");
            block_value_shadow_field2.setAttribute("name", "EXPR");
            block_value_shadow_field2.textContent = "function(arg)";

            block_value_shadow.appendChild(block_value_shadow_field);
            block_value.appendChild(block_value_shadow);
            new_block.appendChild(block_value);

            block_value_shadow2.appendChild(block_value_shadow_field2);
            block_value2.appendChild(block_value_shadow2);
            new_block.appendChild(block_value2);

            i_statement_value.appendChild(new_block);
            i_statement.appendChild(i_statement_value);
            p5_general.appendChild(i_statement);
        }

        // インスタンスを考慮した代入ブロック
        {
            Blockly.Blocks['instance_assignment'] = {
                init: function () {
                    this.appendValueInput("VAR")
                        .setCheck(null);
                    this.appendValueInput("VAL")
                        .setCheck(null)
                        .appendField("に");
                    this.appendEndRowInput()
                        .appendField("をセット");
                    this.setOutput(true, null);
                    this.setColour(230);
                    this.setTooltip("");
                    this.setHelpUrl("");
                }
            };

            // コード生成の定義
            javascript.javascriptGenerator.forBlock['instance_assignment'] = function (block, generator) {
                var value_var = generator.valueToCode(block, 'VAR', javascript.Order.NONE);
                var value_val = generator.valueToCode(block, 'VAL', javascript.Order.NONE);
                // TODO: Assemble javascript into code variable.
                var code = `${value_var} = ${value_val}`;
                // TODO: Change ORDER_NONE to the correct strength.
                return [code, javascript.Order.NONE];
            };

            // ブロック一覧に配置
            let i_statement = document.createElement("block");
            i_statement.setAttribute("type", "instance_statement");
            let i_statement_value = document.createElement("value");
            i_statement_value.setAttribute("name", "EXPR");

            let new_block = document.createElement("block");
            new_block.setAttribute("type", "instance_assignment")

            let block_value = document.createElement("value");
            block_value.setAttribute("name", "VAR");
            let block_value_shadow = document.createElement("shadow");
            block_value_shadow.setAttribute("type", "math_expression");
            let block_value_shadow_field = document.createElement("field");
            block_value_shadow_field.setAttribute("name", "EXPR");
            block_value_shadow_field.textContent = "variable";

            let block_value2 = document.createElement("value");
            block_value2.setAttribute("name", "VAL");
            let block_value_shadow2 = document.createElement("shadow");
            block_value_shadow2.setAttribute("type", "math_expression");
            let block_value_shadow_field2 = document.createElement("field");
            block_value_shadow_field2.setAttribute("name", "EXPR");
            block_value_shadow_field2.textContent = "value";

            block_value_shadow.appendChild(block_value_shadow_field);
            block_value.appendChild(block_value_shadow);
            new_block.appendChild(block_value);

            block_value_shadow2.appendChild(block_value_shadow_field2);
            block_value2.appendChild(block_value_shadow2);
            new_block.appendChild(block_value2);

            i_statement_value.appendChild(new_block);
            i_statement.appendChild(i_statement_value);
            p5_general.appendChild(i_statement);
        }

        // 複数行入力用のブロック
        {
            Blockly.Blocks['multiple_text'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField(new Blockly.FieldMultilineInput("class ExampleClass{\n    // Multiple Text Example\n}"), "TEXT");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(290);
                    this.setTooltip("");
                    this.setHelpUrl("");
                }
            };

            // コード生成の定義
            javascript.javascriptGenerator.forBlock['multiple_text'] = function (block, generator) {
                var value_text = block.getFieldValue("TEXT"); // generator.statementToCode(block, `TEXT`);
                // TODO: Assemble javascript into code variable.
                var code = `${value_text}\n`;
                // TODO: Change ORDER_NONE to the correct strength.
                return code;
            };

            // ブロック一覧に配置
            let new_block = document.createElement("block");
            new_block.setAttribute("type", "multiple_text");
            p5_general.appendChild(new_block);
        }

        // 複数行コメント用のブロック
        {
            Blockly.Blocks['multiple_comment'] = {
                init: function () {
                    this.appendDummyInput()
                        .appendField(new Blockly.FieldMultilineInput("ここから\nここまでコメント"), "TEXT");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(120);
                    this.setTooltip("");
                    this.setHelpUrl("");
                }
            };

            // コード生成の定義
            javascript.javascriptGenerator.forBlock['multiple_comment'] = function (block, generator) {
                var value_text = block.getFieldValue("TEXT"); // generator.statementToCode(block, `TEXT`);
                // TODO: Assemble javascript into code variable.
                var code = `/* ${value_text} */\n`;
                // TODO: Change ORDER_NONE to the correct strength.
                return code;
            };

            // ブロック一覧に配置
            let new_block = document.createElement("block");
            new_block.setAttribute("type", "multiple_comment");
            p5_general.appendChild(new_block);
        }

        function createVarValBlock(class_instance, identifier) {
            Blockly.Blocks[`${class_instance}_${identifier}`] = {
                init: function () {
                    this.appendEndRowInput()
                        .appendField(`${identifier}`)
                    this.setOutput(true, null);
                    this.setColour(230);
                    this.setTooltip("");
                    this.setHelpUrl(`https://p5js.org/reference/#/${class_instance.replaceAll("_", ".")}/${identifier}`);
                }
            };

            // コード生成の定義
            javascript.javascriptGenerator.forBlock[`${class_instance}_${identifier}`] = function (block, generator) {
                // var code = block.getFieldValue(`${f}`.toUpperCase());
                return `${identifier}`;
            };

            // id="p5_category"に<block>を動的に追加する処理
            /*
            <block type="p5_xxx">
                <value name="ARGS">
                    <shadow type="math_expression">
                        <field name="EXPR">0</field>
                    </shadow>
                </value>
            </block>
            */
            let category = document.getElementById(class_instance);
            if (category == null) {
                category = document.createElement("category");
                category.setAttribute("name", class_instance.split("_").join("."));
                category.setAttribute("id", class_instance);
                category.setAttribute("colour", "#ed225e");
            }
            let new_block = document.createElement("block");
            new_block.setAttribute("type", `${class_instance}_${identifier}`);

            category.appendChild(new_block)
            p5_category.appendChild(category);

        }

        function createFunctionBlock(class_instance, identifier, args, overloads_count) {
            if (overloads_count === undefined) {
                overloads_count = "";
            }
            // 関数ブロックの定義
            if (args.length == 0) {
                Blockly.Blocks[`${class_instance}_${identifier}${overloads_count}`] = {
                    init: function () {
                        this.appendEndRowInput()
                            .appendField(`${identifier}(`)
                            .appendField(")");
                        this.setPreviousStatement(true, null);
                        this.setNextStatement(true, null);
                        this.setColour(290);
                        this.setTooltip("");
                        this.setHelpUrl(`https://p5js.org/reference/#/${class_instance.replaceAll("_", ".")}/${identifier}`);
                    }
                };

                // コード生成の定義
                javascript.javascriptGenerator.forBlock[`${class_instance}_${identifier}${overloads_count}`] = function (block, generator) {
                    // var code = block.getFieldValue(`${f}`.toUpperCase());
                    return `${identifier}();\n`;
                };
            } else {
                Blockly.Blocks[`${class_instance}_${identifier}${overloads_count}`] = {
                    init: function () {
                        this.appendValueInput("ARGS")
                            .setCheck(null)
                            .appendField(`${identifier}(`);
                        // 引数の個数だけ処理をする

                        this.appendEndRowInput()
                            .appendField(")");
                        this.setPreviousStatement(true, null);
                        this.setNextStatement(true, null);
                        this.setColour(290);
                        this.setTooltip("");
                        this.setHelpUrl(`https://p5js.org/reference/#/${class_instance.replaceAll("_", ".")}/${identifier}`);
                    }
                };

                // コード生成の定義
                javascript.javascriptGenerator.forBlock[`${class_instance}_${identifier}${overloads_count}`] = function (block, generator) {
                    var value_name = generator.valueToCode(block, `ARGS`.toUpperCase(), javascript.Order.NONE); // ex. (10, 20, 30, 40): if Order.ATOMIC, 10, 20, 30, 40: if Order.NONE
                    // var code = block.getFieldValue(`${f}`.toUpperCase());
                    return `${identifier}(${value_name});\n`;
                };
            }


            // id="p5_category"に<block>を動的に追加する処理
            /*
            <block type="p5_xxx">
                <value name="ARGS">
                    <shadow type="math_expression">
                        <field name="EXPR">0</field>
                    </shadow>
                </value>
            </block>
            */
            let category = document.getElementById(class_instance);
            if (category == null) {
                category = document.createElement("category");
                category.setAttribute("name", class_instance.split("_").join("."));
                category.setAttribute("id", class_instance);
                category.setAttribute("colour", "#ed225e");
            }
            let new_block = document.createElement("block");
            new_block.setAttribute("type", `${class_instance}_${identifier}${overloads_count}`);

            if (args.length == 0) {

            } else {
                let block_value = document.createElement("value");
                block_value.setAttribute("name", "ARGS");
                let block_value_shadow = document.createElement("shadow");
                block_value_shadow.setAttribute("type", "math_expression");
                let block_value_shadow_field = document.createElement("field");
                block_value_shadow_field.setAttribute("name", "EXPR");
                block_value_shadow_field.textContent = "0";
                block_value_shadow.appendChild(block_value_shadow_field);
                block_value.appendChild(block_value_shadow);
                new_block.appendChild(block_value);
            }
            category.appendChild(new_block)
            p5_category.appendChild(category);

        }

        function createEventBlock(class_instance, identifier) {
            Blockly.Blocks[`${class_instance}_${identifier}`] = {
                init: function () {
                    this.appendEndRowInput()
                        .appendField(`${identifier}`);
                    this.appendStatementInput("STATEMENTS")
                        .setCheck(null);
                    this.setColour(290);
                    this.setTooltip("");
                    this.setHelpUrl(`https://p5js.org/reference/#/${class_instance.replaceAll("_", ".")}/${identifier}`);
                }
            };

            // コード生成の定義
            javascript.javascriptGenerator.forBlock[`${class_instance}_${identifier}`] = function (block, generator) {
                var code = `function ${identifier}(){\n${generator.statementToCode(block, 'STATEMENTS')}}`;
                return code;
            };

            // id="p5_category"に<block>を動的に追加する処理
            /*
            <block type="p5_xxx">
                <value name="ARGS">
                    <shadow type="math_expression">
                        <field name="EXPR">0</field>
                    </shadow>
                </value>
            </block>
            */
            let category = document.getElementById(class_instance);
            if (category == null) {
                category = document.createElement("category");
                category.setAttribute("name", class_instance.split("_").join("."));
                category.setAttribute("id", class_instance);
                category.setAttribute("colour", "#ed225e");
            }
            let new_block = document.createElement("block");
            new_block.setAttribute("type", `${class_instance}_${identifier}`);

            category.appendChild(new_block)
            p5_category.appendChild(category);

        }


        // test for p5 block
        // let functions = ["fill", "rect", "ellipse", "line"]
        // for (const f of functions) {
        //     createFunctionBlock("p5", f, null);
        // }
        // for (const f of functions) {
        //     // リストにあるp5の関数ブロックの定義
        //     Blockly.Blocks[`p5_${f}`] = {
        //         init: function () {
        //             this.appendValueInput("ARGS")
        //                 .setCheck(null)
        //                 .appendField(`${f}(`);
        //             this.appendEndRowInput()
        //                 .appendField(")");
        //             this.setPreviousStatement(true, null);
        //             this.setNextStatement(true, null);
        //             this.setColour(290);
        //             this.setTooltip("");
        //             this.setHelpUrl(`https://p5js.org/reference/#/p5/${f}`);
        //         }
        //     };

        //     // コード生成の定義
        //     javascript.javascriptGenerator.forBlock[`p5_${f}`] = function (block, generator) {
        //         var value_name = generator.valueToCode(block, `ARGS`.toUpperCase(), javascript.Order.NONE); // ex. (10, 20, 30, 40): if Order.ATOMIC, 10, 20, 30, 40: if Order.NONE
        //         // var code = block.getFieldValue(`${f}`.toUpperCase()); 
        //         return `${f}(${value_name});\n`;
        //     };

        //     // id="p5_category"に<block>を動的に追加する処理
        //     /*
        //     <block type="p5_xxx">
        //         <value name="ARGS">
        //             <shadow type="math_expression">
        //                 <field name="EXPR">0</field>
        //             </shadow>
        //         </value>
        //     </block>
        //     */
        //     let new_block = document.createElement("block");
        //     new_block.setAttribute("type", `p5_${f}`);
        //     let block_value = document.createElement("value");
        //     block_value.setAttribute("name", "ARGS");
        //     let block_value_shadow = document.createElement("shadow");
        //     block_value_shadow.setAttribute("type", "math_expression");
        //     let block_value_shadow_field = document.createElement("field");
        //     block_value_shadow_field.setAttribute("name", "EXPR");
        //     block_value_shadow_field.textContent = "0";
        //     block_value_shadow.appendChild(block_value_shadow_field);
        //     block_value.appendChild(block_value_shadow);
        //     new_block.appendChild(block_value);
        //     p5_category.appendChild(new_block);
        // }

        // 文ブロックの定義
        Blockly.Blocks['p5_statement'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField(new Blockly.FieldTextInput("console.log()"), "STATEMENT")
                    .appendField(";");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(290);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };

        // コード生成の定義
        javascript.javascriptGenerator.forBlock[`p5_statement`] = function (block, generator) {
            var value_name = block.getFieldValue(`STATEMENT`);
            return `${value_name};\n`;
        };

        // p5カテゴリに追加
        {
            let new_block = document.createElement("block");
            new_block.setAttribute("type", `p5_statement`);
            p5_general.appendChild(new_block);
        }


        let p5_raw = undefined;
        {
            // JSON import
            // XMLHttpRequestを使ってjsonデータを読み込む
            let requestURL = 'p5/p5-all-functions.json';//jsonへのパス
            let request = new XMLHttpRequest();
            request.open('GET', requestURL);
            request.responseType = 'json';
            request.send();

            // JSONデータをJavaScriptオブジェクトに変換
            request.onload = function () {
                let data = request.response;
                data = JSON.parse(JSON.stringify(data));
                p5_raw = data;
                console.log(data)
                for (const e1 in p5_raw) {
                    if (e1 === "JSON" || e1 === "console") {
                        continue;
                    } else {
                        let class_instance = null;
                        try {
                            // p5の場合
                            class_instance = new window[e1]();

                            createBlockfromJson(class_instance, e1);
                            // for (const e2 in p5_raw[e1]) {
                            //     if (p5_raw[e1][e2]["module"] !== "Foundation") {
                            //         // console.log(`${e1}.${e2}`);
                            //         let identifier = class_instance[e2]
                            //         if (typeof identifier === "function") {
                            //             // 関数
                            //             if (p5_raw[e1][e2]["params"] !== undefined) {
                            //                 // オーバーロードなし
                            //                 createFunctionBlock(e1, e2, p5_raw[e1][e2]["params"]);
                            //             } else if (p5_raw[e1][e2]["overloads"] !== undefined) {
                            //                 // オーバーロードあり
                            //                 for (let i = 0; i < p5_raw[e1][e2]["overloads"].length; i++) {
                            //                     createFunctionBlock(e1, e2, p5_raw[e1][e2]["overloads"][i].params);
                            //                 }
                            //             }
                            //         } else {
                            //             // 変数

                            //         }
                            //     } else if (p5_raw[e1][e2]["module"] !== "Constants") {
                            //         // 定数

                            //     }
                            // }
                        } catch (error) {
                            try {
                                // p5.XXX の場合
                                let l = e1.split(".");
                                class_instance = new window[l[0]][l[1]]();

                                createBlockfromJson(class_instance, e1);
                                // for (const e2 in p5_raw[e1]) {
                                //     if (p5_raw[e1][e2]["module"] !== "Foundation") {
                                //         // console.log(`${e1}.${e2}`);
                                //         let identifier = class_instance[e2]
                                //         if (typeof identifier === "function") {
                                //             // 関数
                                //             if (p5_raw[e1][e2]["params"] !== undefined) {
                                //                 // オーバーロードなし
                                //                 createFunctionBlock(e1, e2, p5_raw[e1][e2]["params"]);
                                //             } else if (p5_raw[e1][e2]["overloads"] !== undefined) {
                                //                 // オーバーロードあり
                                //                 for (let i = 0; i < p5_raw[e1][e2]["overloads"].length; i++) {
                                //                     createFunctionBlock(e1, e2, p5_raw[e1][e2]["overloads"][i].params);
                                //                 }
                                //             }
                                //         } else {
                                //             // 変数

                                //         }
                                //     } else if (p5_raw[e1][e2]["module"] !== "Constants") {
                                //         // 定数

                                //     }
                                // }
                            } catch (error2) {
                                try {
                                    // p5.XXX の場合(コンストラクタの生成が特殊な場合)
                                    let l = e1.split(".");

                                    if (l[1] === "Color") {
                                        // p5.Color
                                        class_instance = color(0);
                                    } else if (l[1] === "Element") {
                                        // p5.Element
                                        class_instance = new p5.Element(createElement(null));
                                    } else if (l[1] === "Graphics") {
                                        // p5.Graphics
                                        class_instance = createGraphics(0, 0);
                                    } else if (l[1] === "MediaElement") {
                                        // p5.MediaElement
                                        class_instance = createAudio();
                                    } else if (l[1] === "File") {
                                        // p5.File
                                        class_instance = new p5.File(new File([], null))
                                    } else if (l[1] === "Framebuffer") {
                                        // p5.Framebuffer
                                        let _ = new p5();
                                        _.createCanvas(0, 0, WEBGL);
                                        class_instance = _.createFramebuffer();
                                    } else if (l[1] === "Amplitude") {
                                        // p5.Amplitude
                                        setTimeout(() => {
                                            class_instance = new p5.Amplitude();
                                            // console.log(class_instance);
                                            createBlockfromJson(class_instance, e1);
                                            // updateToolbox();
                                            // blocklyReset();
                                            // workspace.addChangeListener(updateCode);
                                        }, 500);
                                        continue;
                                    } else if (l[1] === "AudioIn") {
                                        // p5.AudioIn
                                        setTimeout(() => {
                                            class_instance = new p5.Amplitude();
                                            // console.log(class_instance);
                                            createBlockfromJson(class_instance, e1);
                                            // updateToolbox();
                                            // blocklyReset();
                                            // workspace.addChangeListener(updateCode);
                                        }, 500);
                                        continue;
                                    } else if (l[1] === "SoundRecorder") {
                                        // p5.SoundRecorder
                                        setTimeout(() => {
                                            class_instance = new p5.Amplitude();
                                            // console.log(class_instance);
                                            createBlockfromJson(class_instance, e1);
                                            // updateToolbox();
                                            // blocklyReset();
                                            // workspace.addChangeListener(updateCode);
                                        }, 500);
                                        continue;
                                    }
                                    createBlockfromJson(class_instance, e1);
                                    // for (const e2 in p5_raw[e1]) {
                                    //     if (p5_raw[e1][e2]["module"] !== "Foundation") {
                                    //         // console.log(`${e1}.${e2}`);
                                    //         let identifier = class_instance[e2]
                                    //         if (typeof identifier === "function") {
                                    //             // 関数
                                    //             if (p5_raw[e1][e2]["params"] !== undefined) {
                                    //                 // オーバーロードなし
                                    //                 createFunctionBlock(e1, e2, p5_raw[e1][e2]["params"]);
                                    //             } else if (p5_raw[e1][e2]["overloads"] !== undefined) {
                                    //                 // オーバーロードあり
                                    //                 for (let i = 0; i < p5_raw[e1][e2]["overloads"].length; i++) {
                                    //                     createFunctionBlock(e1, e2, p5_raw[e1][e2]["overloads"][i].params);
                                    //                 }
                                    //             }
                                    //         } else {
                                    //             // 変数

                                    //         }
                                    //     } else if (p5_raw[e1][e2]["module"] !== "Constants") {
                                    //         // 定数

                                    //     }
                                    // }
                                } catch (error3) {
                                    // console.error(`${e1}: ${error}`);
                                    // console.error(`${e1}: ${error2}`);
                                    console.error(`${e1}: ${error3}`);
                                }
                            }
                        }
                    }
                }
                setTimeout(() => {
                    updateToolbox();
                    blocklyReset();
                    // workspace.clear();
                    // Blockly.Xml.domToWorkspace(document.getElementById("startBlocks"), workspace);
                    workspace.addChangeListener(updateCode);
                }, 500);
            }
        }

        function createBlockfromJson(class_instance, e1) {
            for (const e2 in p5_raw[e1]) {
                if (p5_raw[e1][e2]["module"] !== "Foundation") {
                    // console.log(`${e1}.${e2}`);
                    let identifier = class_instance[e2]
                    if (typeof identifier === "function") {
                        // 関数
                        if (p5_raw[e1][e2]["params"] !== undefined) {
                            // オーバーロードなし
                            createFunctionBlock(e1.split(".").join("_"), e2, p5_raw[e1][e2]["params"]);
                        } else if (p5_raw[e1][e2]["overloads"] !== undefined) {
                            // オーバーロードあり
                            for (let i = 0; i < p5_raw[e1][e2]["overloads"].length; i++) {
                                createFunctionBlock(e1.split(".").join("_"), e2, p5_raw[e1][e2]["overloads"][i].params, `_${i}`);
                            }
                        } else if (p5_raw[e1][e2]["overloads"] === undefined && p5_raw[e1][e2]["overloads"] === undefined) {
                            // 引数なし
                            console.log(`${e1}.${e2}`);
                            if (e2 !== "preload") {
                                createFunctionBlock(e1.split(".").join("_"), e2, []);
                            }
                        }
                    } else {
                        if (p5_raw[e1][e2]["params"] !== undefined) {
                            // イベント
                            createEventBlock(e1.split(".").join("_"), e2);
                        } else if ((e2 !== "preload" && e2 !== "setup" && e2 !== "draw")) {
                            // 変数、定数
                            createVarValBlock(e1.split(".").join("_"), e2);
                        }
                    }
                }
            }
        }

        let toolbox = null;
        let workspace = null;
        let workspaceBlocks = null;
        function updateToolbox() {
            /* TODO: Change toolbox XML ID if necessary. Can export toolbox XML from Workspace Factory. */
            var toolbox = document.getElementById("toolbox");

            var options = {
                toolbox: toolbox,
                collapse: true,
                comments: true,
                disable: true,
                maxBlocks: Infinity,
                trashcan: true,
                horizontalLayout: false,
                toolboxPosition: 'start',
                css: true,
                media: 'https://blockly-demo.appspot.com/static/media/',
                rtl: false,
                scrollbars: true,
                sounds: true,
                oneBasedIndex: true,
                grid: {
                    spacing: 20,
                    length: 2,
                    colour: '#888',
                    snap: false
                },
                zoom: {
                    controls: true,
                    wheel: true,
                    startScale: 1,
                    maxScale: 3,
                    minScale: 0.3,
                    scaleSpeed: 1.2
                }
            };

            /* Inject your workspace */
            workspace = Blockly.inject("blocklyDiv", options);
            /* Load Workspace Blocks from XML to workspace. Remove all code below if no blocks to load */

            /* TODO: Change workspace blocks XML ID if necessary. Can export workspace blocks XML from Workspace Factory. */
            workspaceBlocks = document.getElementById("startBlocks");

            /* Load blocks to workspace. */
            Blockly.Xml.domToWorkspace(workspaceBlocks, workspace);
        }


        function updateCode(event) {
            if (workspace.isDragging()) return; // Don't update while changes are happening.
            if (!supportedEvents.has(event.type)) return;

            const currentXML = Blockly.Xml.workspaceToDom(workspace);
            if (loadedXml == undefined) {
                loadedXml = Blockly.Xml.workspaceToDom(workspace);
            }
            if (title == undefined) {
                if (Blockly.Xml.domToText(Blockly.Xml.workspaceToDom(workspace)) != Blockly.Xml.domToText(loadedXml)) {
                    document.getElementById("fileName").innerText = untitled + "*";
                } else {
                    document.getElementById("fileName").innerText = untitled;
                }
            } else {
                if (Blockly.Xml.domToText(Blockly.Xml.workspaceToDom(workspace)) != Blockly.Xml.domToText(loadedXml)) {
                    document.getElementById("fileName").innerText = title + "*";
                } else {
                    document.getElementById("fileName").innerText = title;
                }
            }
            const code = javascript.javascriptGenerator.workspaceToCode(workspace);
            // document.getElementById('textarea').value = code;
            // console.log(code);
            if (editor != null)
                editor.setValue(code);
        }

        // workspace.addChangeListener(updateCode);


        function showBlock() {
            let blocklyContent = document.getElementById("blocklyDiv");
            let textContent = document.getElementById("textDiv");
            blocklyContent.hidden = false;
            textContent.hidden = true;
        }

        function showText() {
            let blocklyContent = document.getElementById("blocklyDiv");
            let textContent = document.getElementById("textDiv");
            blocklyContent.hidden = true;
            textContent.hidden = false;
        }

        async function blocklyOpenFile() {
            // Supports Chrome or Edge (Firefox and Safari are not supported)
            const options = {
                types: [
                    {
                        description: "Text Files",
                        accept: {
                            "text/plain": [".blk", ".xml"],
                        },
                    },
                ],
            };

            const handle = await window.showOpenFilePicker(options);
            const file = await handle[0].getFile();
            title = handle[0].name;
            document.getElementById("fileName").innerText = title;
            const text = await file.text();
            console.log(text); // 内容を出力

            loadedXml = Blockly.utils.xml.textToDom(text);
            workspace.clear();
            Blockly.Xml.domToWorkspace(loadedXml, workspace);
        }

        // 書き込み処理
        async function writeBlockFile(fileHandle, contents) {
            // writable作成
            const writable = await fileHandle.createWritable();

            // コンテンツを書き込む
            await writable.write(contents);

            // ファイル閉じる
            await writable.close();
        }

        async function blocklySaveFile(isOverWrite) {
            // メイン処理false
            const saveFileOptions = {
                types: [
                    {
                        description: "Block Files",
                        accept: {
                            "text/xml": [".blk", ".xml"],
                        },
                    },
                ],
            };
            if (isOverWrite) {
                let xml = Blockly.Xml.workspaceToDom(workspace);
                /* 上書き保存（初回はglobalHandleがundefinedなので[名前をつけて保存]を実行）*/
                globalHandle = await saveFile(Blockly.Xml.domToText(xml), globalHandle, saveFileOptions);
                loadedXml = xml;
            } else {
                let xml = Blockly.Xml.workspaceToDom(workspace);
                /* 名前を付けて保存 */
                globalHandle = await saveFile(Blockly.Xml.domToText(xml), null, saveFileOptions);
                loadedXml = xml;
            }
            console.log('書き込み完了');
        }

        // 上書き保存
        async function saveFile(contents, handle, options) {
            if (!handle) {
                handle = await window.showSaveFilePicker(options);
                title = handle.name;
            }
            document.getElementById("fileName").innerText = title;
            await writeBlockFile(handle, contents);
            return handle;
        }

        function openModal(id) {

        }

        function blocklyReset() {
            workspace.clear();
            Blockly.Xml.domToWorkspace(document.getElementById("startBlocks"), workspace);
            loadedXml = undefined;
            title = untitled;
            document.getElementById("fileName").innerText = untitled;
            globalHandle = undefined;
        }

        function blocklyNewFile() {
            // ダイアログ
            const modal = new bootstrap.Modal(document.getElementById("saveRemindModal"));
            if (document.getElementById("fileName").innerText.includes("*")) {
                modal.show();
                return;
            }
            modal.hide();

            blocklyReset();
        }
    </script>

    <script>
        window.addEventListener("DOMContentLoaded", event => {
            if (navigator.userAgent.toLowerCase().includes("mac")) {
                // MacOS
                document.getElementById("f_new").innerText += ` (${String.fromCodePoint(0x2303)}${String.fromCodePoint(0x2325)}${String.fromCodePoint(0x2318)} N)`; // control + option + command + N
                document.getElementById("f_open").innerText += ` (${String.fromCodePoint(0x2318)}O)`;
                document.getElementById("f_save").innerText += ` (${String.fromCodePoint(0x2318)}S)`;
                document.getElementById("f_saveas").innerText += ` (${String.fromCodePoint(0x21e7)}${String.fromCodePoint(0x2318)}S)`;
            } else {
                // MacOS以外
                document.getElementById("f_new").innerText += " (Ctrl+N)";
                document.getElementById("f_open").innerText += " (Ctrl+O)";
                document.getElementById("f_save").innerText += " (Ctrl+S)";
                document.getElementById("f_saveas").innerText += " (Ctrl+Shift+S)";
            }
        });

        window.addEventListener("resize", function () {
            let container = document.getElementById("container");
            console.log(container);
            container.style.width = "100%";
            container.style.height = "100vh";

            // テキストタブにしてウィンドウサイズを変えると、ブロックタブに戻ったときに描画されない問題を修正
            let tmpXml = Blockly.Xml.workspaceToDom(workspace);
            workspace.clear();
            Blockly.Xml.domToWorkspace(loadedXml, workspace);
        });

        window.addEventListener("keydown", event => {
            if (navigator.userAgent.toLowerCase().includes("mac")) {
                // MacOS
                console.log("mac");
                if (event.metaKey) {
                    if (event.code === "KeyO") {
                        console.log("cmd O");
                        event.preventDefault(); // ブラウザに定義済みのキーショートカットを呼び出さない
                        blocklyOpenFile()
                    } else if (event.shiftKey && event.code === "KeyS") {
                        console.log("cmd shift S");
                        event.preventDefault();
                        blocklySaveFile(false);
                    } else if (event.code === "KeyS") {
                        console.log("cmd S");
                        event.preventDefault();
                        blocklySaveFile(true);
                    } else if (event.ctrlKey && event.altKey && event.code === "KeyN") {
                        console.log("control option command N");
                        event.preventDefault();
                        blocklyNewFile();
                    }
                }
            } else {
                // MacOS以外
                if (event.ctrlKey) {
                    if (event.code === "KeyO") {
                        event.preventDefault();
                        blocklyOpenFile()
                    } else if (event.shiftKey && event.code === "KeyS") {
                        event.preventDefault();
                        blocklySaveFile(false);
                    } else if (event.code === "KeyS") {
                        event.preventDefault();
                        blocklySaveFile(true);
                    } else if (event.code === "KeyN") {
                        event.preventDefault();
                        blocklyNewFile();
                    }
                }
            }
        });
    </script>
</body>

</html>